-- =====================================================
-- CORRECCI√ìN URGENTE DE VULNERABILIDAD DE SEGURIDAD
-- Revocar permisos excesivos y otorgar solo los m√≠nimos necesarios
-- =====================================================

-- PASO 1: REVOCAR TODOS LOS PERMISOS PELIGROSOS DEL ROL AUTHENTICATED
DO $$
DECLARE
    table_record RECORD;
BEGIN
    RAISE NOTICE 'üö® INICIANDO CORRECCI√ìN URGENTE DE SEGURIDAD';
    RAISE NOTICE '';
    RAISE NOTICE 'üîí Revocando permisos excesivos del rol authenticated...';
    
    -- Revocar TODOS los permisos del rol authenticated en todas las tablas
    FOR table_record IN 
        SELECT table_name 
        FROM information_schema.tables 
        WHERE table_schema = 'public' 
        AND table_type = 'BASE TABLE'
    LOOP
        BEGIN
            -- Revocar TODOS los permisos peligrosos
            EXECUTE format('REVOKE ALL PRIVILEGES ON public.%I FROM authenticated', table_record.table_name);
            RAISE NOTICE 'üîí Revoked ALL permissions on table: %', table_record.table_name;
        EXCEPTION
            WHEN OTHERS THEN
                RAISE NOTICE '‚ö†Ô∏è  Could not revoke permissions on %: %', table_record.table_name, SQLERRM;
        END;
    END LOOP;
    
    RAISE NOTICE '';
    RAISE NOTICE '‚úÖ Todos los permisos excesivos han sido revocados';
    RAISE NOTICE '';
END $$;

-- PASO 2: OTORGAR SOLO LOS PERMISOS M√çNIMOS NECESARIOS
DO $$
DECLARE
    target_table text;
    essential_tables text[] := ARRAY[
        'profiles',
        'properties', 
        'property_images',
        'documents'
    ];
BEGIN
    RAISE NOTICE 'üîê Otorgando SOLO permisos m√≠nimos esenciales...';
    RAISE NOTICE '';
    
    -- Otorgar SOLO SELECT, INSERT, UPDATE, DELETE (sin TRUNCATE, TRIGGER, REFERENCES)
    FOREACH target_table IN ARRAY essential_tables
    LOOP
        IF EXISTS (
            SELECT 1 FROM information_schema.tables t
            WHERE t.table_schema = 'public' 
            AND t.table_name = target_table
        ) THEN
            -- Otorgar SOLO los permisos esenciales y seguros
            EXECUTE format('GRANT SELECT, INSERT, UPDATE, DELETE ON public.%I TO authenticated', target_table);
            RAISE NOTICE 'üîê Granted MINIMAL permissions (SELECT,INSERT,UPDATE,DELETE) on: %', target_table;
        ELSE
            RAISE NOTICE '‚ö†Ô∏è  Table does not exist: %', target_table;
        END IF;
    END LOOP;
    
    RAISE NOTICE '';
    RAISE NOTICE '‚úÖ Solo permisos m√≠nimos y seguros otorgados';
    RAISE NOTICE '';
END $$;

-- PASO 3: VERIFICAR QUE LA SEGURIDAD EST√Å CORRECTAMENTE CONFIGURADA
SELECT '=== VERIFICACI√ìN POST-SEGURIDAD ===' as security_check;
SELECT 
  t.table_name,
  string_agg(t.privilege_type, ', ' ORDER BY t.privilege_type) as permissions
FROM information_schema.table_privileges t
WHERE t.grantee = 'authenticated' 
  AND t.table_schema = 'public'
GROUP BY t.table_name
ORDER BY t.table_name;

-- PASO 4: CONFIRMAR QUE RLS SIGUE ACTIVO
SELECT '=== VERIFICACI√ìN RLS ACTIVO ===' as rls_check;
SELECT 
  tablename,
  rowsecurity as rls_enabled
FROM pg_tables 
WHERE schemaname = 'public' 
  AND tablename IN ('profiles', 'properties')
ORDER BY tablename;

-- PASO 5: MENSAJE DE CONFIRMACI√ìN DE SEGURIDAD
DO $$
BEGIN
    RAISE NOTICE '';
    RAISE NOTICE 'üõ°Ô∏è  VULNERABILIDAD DE SEGURIDAD CORREGIDA';
    RAISE NOTICE '';
    RAISE NOTICE '‚úÖ Acciones realizadas:';
    RAISE NOTICE '   - Revocados TODOS los permisos excesivos (TRUNCATE, TRIGGER, REFERENCES)';
    RAISE NOTICE '   - Otorgados SOLO permisos m√≠nimos (SELECT, INSERT, UPDATE, DELETE)';
    RAISE NOTICE '   - Las pol√≠ticas RLS siguen siendo la l√≠nea principal de defensa';
    RAISE NOTICE '';
    RAISE NOTICE 'üîí Configuraci√≥n de seguridad:';
    RAISE NOTICE '   - RLS: ACTIVO (controla qu√© filas puede ver/editar cada usuario)';
    RAISE NOTICE '   - Permisos de tabla: M√çNIMOS (solo operaciones b√°sicas)';
    RAISE NOTICE '';
    RAISE NOTICE 'üìã Pr√≥ximos pasos:';
    RAISE NOTICE '1. Verifica que solo aparezcan permisos m√≠nimos arriba';
    RAISE NOTICE '2. Recarga tu aplicaci√≥n y prueba si funciona';
    RAISE NOTICE '3. Los errores 406 deber√≠an resolverse SIN comprometer seguridad';
    RAISE NOTICE '';
    RAISE NOTICE '‚ö†Ô∏è  Si a√∫n hay errores 406, el problema es diferente';
    RAISE NOTICE '';
END $$;
